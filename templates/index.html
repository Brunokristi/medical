<!DOCTYPE html>
<html lang="sk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ADOS - Formulár pre správu údajov">
    <title>ADOS</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@200;300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRnAl8oUEx8je9s7J0zB7vPxIxAgyc_8c&libraries&libraries=places&callback=initMap" async defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">  
    <script src="{{ url_for('static', filename='js/posts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/calendars.js') }}"></script>
</head>
<body>
    <div class="top">
        <h1>ADOS</h1>
        <div class="one-line">
            <h2>{{ nurse['meno'] }}</h2>
            <a href="{{ url_for('index') }}">Odhlásiť sa</a>
            <a href="#" onclick="shutDown(); return false;">Vypnúť aplikáciu</a>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>

    <div id="delete-popup" class="popup">
        <div class="popup-content">
            <p>Naozaj vymazať pacienta?</p>
            <button onclick="deletePatientDay()">Vymazať pacienta v tento deň</button>
            <button onclick="deletePatientMonth()">Vymazať pacienta tento mesiac</button>
            <button onclick="deletePatientDatabase()">Vymazať pacienta z databázy</button>
            <button onclick="closeDeletePopup()">Zrušiť</button>
        </div>
    </div>

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
    </div>

    <div class="main">
        <div class="left container">
            <div class="section">
                <h2 class="lined-heading"><span>Rozpracované mesiace<span></h2>
                <div class="months_scroll">
                    {% for vypisany in vypisane_mesiace %}
                    <a class="month-token"
                        href="{{ url_for('detail', nurse_id=nurse.id, month=vypisany.mesiac, year=vypisany.rok) }}">
                        {{ vypisany.mesiac }}/{{ vypisany.rok }}
                    </a>
                    {% endfor %}
                </div>
            </div>

            <div class="section">
                <h2 class="lined-heading"><span>Začať nový mesiac<span></h2>

                <input type="hidden" id="nurse_id" value="{{ nurse['id'] }}">
            
                <div class="form-group">
                    <label for="month">Mesiac</label>
                    <input type="month" id="month" required onchange="updateCalendar()">
                </div>
            
                <div class="hidden">
                    <div class="half-form-group">
                        <div class="form-group">
                            <label for="zs_start_time">Čas poskytnutia ZS</label>
                            <input type="time" id="zs_start_time" value="08:00" required>
                        </div>
            
                        <div class="form-group">
                            <input type="time" id="zs_end_time" value="14:00" required>
                        </div>
                    </div>
            
                    <div class="half-form-group">
                        <div class="form-group">
                            <label for="write_start_time">Čas zápisu</label>
                            <input type="time" id="write_start_time" value="14:00" required>
                        </div>
            
                        <div class="form-group">
                            <input type="time" id="write_end_time" value="15:30" required>
                        </div>
                    </div>
                </div>

                <button class="text-button"><i class="bi bi-chevron-compact-down"></i></button>
            
                <button class="btn" onclick="postMonth()">Zvoliť mesiac</button>
            </div>

            <div class="section" id="patient-section">
                <h2 class="lined-heading"><span>Pacient</span></h2>
                <div class="form-group">
                    <label for="rodne_cislo">Rodné číslo</label>
                    <input type="text" id="rodne_cislo" name="rodne_cislo" maxlength="11" oninput="searchPatient()" autocomplete="off" required>
                    <div id="suggestions" class="suggestions"></div>
                </div>

                <div class="form-group">
                    <label for="meno">Meno</label>
                    <input type="text" id="meno" name="meno" required>
                </div>
                
                <div class="form-group">
                    <label for="adresa">Adresa</label>
                    <input type="text" id="adresa" name="adresa" required autocomplete="off" oninput="fetchSuggestions()">
                    <div id="address-suggestions" class="suggestions"></div>
                </div>
                
                <div class="form-group">
                    <label for="poistovna">Zdravotná poisťovňa</label>
                    <select id="poistovna" name="poistovna" required>
                        <option>24 – DÔVERA zdravotná poisťovňa, a. s.</option>
                        <option>25 – VŠEOBECNÁ zdravotná poisťovňa, a. s.</option>
                        <option>27 – UNION zdravotná poisťovňa, a. s.</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="company">ADOS</label>
                    <select id="company" name="company" required>
                        <option>Andramed</option>
                        <option>ADANED</option>
                    </select>
                </div>
                
                <h2 class="lined-heading" style="margin-top: 20px;"><span>Dátumy a časy</span></h2>
                
                
                <div class="half-form-group">
                    <div class="form-group">
                        <label for="date_start">Poskytovanie ZS</label>
                        <input class="dates" type="text" id="date_start" name="date_start" placeholder="Vyberte dátum" autocomplete="off">
                    </div>
                
                    <div class="form-group">
                        <input class="dates" type="text" id="date_end" name="date_end" placeholder="Vyberte dátum" autocomplete="off">
                    </div>
                </div>


                <div class="form-group">
                    <label for="schedule">Opakovanie</label>
                    <select id="schedule" name="schedule" required>
                        <option value="daily">Každý deň</option>
                        <option value="weekday">Každý pracovný deň</option>
                        <option value="3x_week">3x v týždni</option>
                    </select>
                </div>

                <div class="one-line">
                    <button class="btn warning" onclick="clearInputs()">Vymazať</button>
                    <button class="btn" onclick="postPatientAndSchedule(); clearInputs()">Pridať</button>
                </div>
            </div>

            <div class="section" id="route-section">
                <h2 class="lined-heading"><span>Plánovanie cesty<span></h2>

                <div class="one-line">
                        <button id="prevDay"><i class="bi bi-arrow-left-short"></i></button>
                        <h3 class="selected-date" id="selectedDate">{{ days[0]['datum'] if days else 'Žiadne dátumy' }}</h3>
                        <button id="nextDay"><i class="bi bi-arrow-right-short"></i></button>
                </div>

                <div class="form-group">
                    <label for="start">Začiatok cesty</label>
                    <select id="start" name="start" required onchange="updateRoute()">
                        <option>Jánošíkova 2, Rimavská Sobota, BC, Slovensko</option>
                        <option>SNP 8, Fiľakovo, BC, Slovensko</option>
                    </select>
                </div>

                <div id="patientList">
                </div>
                
                <h2 class="lined-heading"><span>Informácia o ceste</span></h2>
                
                
                <div id="map" style="height: 400px; width: 100%; margin-top: 20px;"></div>

                <div class="checkbox-container">
                    <input type="checkbox" id="custom-route" name="custom-route" checked onchange="updateRoute()" />
                    <label for="custom-route">Najoptimálnejšia cesta</label>
                </div>

                <table  class="route-table" id="route-info"></table>

                <button class="btn" onclick="schedulePatientsMonth()">Uložiť rozpis mesiaca</button>
            </div>
        </div>

        <div class="right container">
            <div class="section" id="dekurz-section">
                <div class="scroll">
                    {% for patient in patients_in_month %}
                    <button class="small-token" data-id="{{ patient.id }}">
                        {{ patient.meno }} ({{ patient.rodne_cislo }})
                    </button>
                    {% endfor %}
                </div>
                
                <h2 class="lined-heading"><span>Pacient</span></h2>

                <div class="patient-info">
                </div>
                <input type="hidden" id="patient_input_id">
                <input type="hidden" id="start_date_patient">
                <input type="hidden" id="end_date_patient">


                <h2 class="lined-heading"><span>Nález</span></h2>
                
                
                {% for i in range(1, 9) %}
                <div class="form-group">
                    <label for="podtext-{{ i }}" style="margin-top: 30px;">Text Dekurzu {{ i }}</label>
                    <textarea id="podtext-{{ i }}" name="podtext-{{ i }}" rows="5"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="date_picker_{{ i }}">Dátumy</label>
                    <div class="one-line">
                        <input class="dates" type="text" id="date_picker_{{ i }}" placeholder="Vyberte dátumy" autocomplete="off">
                
                        <input type="hidden" id="dates_list_{{ i }}" name="dates_list_{{ i }}">
                    
                        <textarea id="copy_paste_dates_{{ i }}" class="copy-paste-dates" rows="1"
                            placeholder="Kopírujte dátumy sem"></textarea>
                    </div>
                </div>
                {% endfor %}

                <div class="form-group">
                    <label for="entry_number" style="margin-top: 30px;">Číslo dekurzu</label>
                    <input type="number" id="entry_number" name="entry_number" required>
                </div>                
                
                <div style="display: flex; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="updateForDekurz()">Vytvoriť Dekurz</button>
                </div>
            </div>
        </div>
    </div>

</body>

<script>
    let autocompleteService;
    let map;
    let routeLayer;
    let patientMarkers = [];
    let selectedDates = [];
    let month = "{{ month.mesiac }}" || null;
    let start = "{{ month.vysetrenie_start }}" || null;
    let end = "{{ month.vysetrenie_koniec }}" || null;
    let write_start = "{{ month.vypis_start }}" || null;
    let write_end = "{{ month.vypis_koniec }}" || null;
    let year = "{{ month.rok }}" || null;
    let days = JSON.parse('{{ days | tojson | safe }}');
    let patients_by_day = JSON.parse('{{ patients_by_day | tojson | safe }}');
    let patients_in_month = '{{ patients_in_month | tojson | safe }}';

    window.onload = function () {
        setTodayDate();
        updateCalendar();
    };

    

    document.addEventListener("DOMContentLoaded", function () {
        const toggleButton = document.querySelector(".text-button");
        const hiddenSection = document.querySelector(".hidden");
        const icon = toggleButton.querySelector("i");

        toggleButton.addEventListener("click", function () {
            if (hiddenSection.classList.contains("show")) {
                hiddenSection.classList.remove("show");
                icon.classList.remove("bi-chevron-compact-up");
                icon.classList.add("bi-chevron-compact-down");
            } else {
                hiddenSection.classList.add("show");
                icon.classList.remove("bi-chevron-compact-down");
                icon.classList.add("bi-chevron-compact-up");
            }
        });

        focusRodneCislo();
    });

    function focusRodneCislo() {
        setTimeout(() => {
            let input = document.getElementById("rodne_cislo");
            if (input) {
                input.focus();
            }
        }, 500);
    }

    function searchPatient() {
        let input = document.getElementById("rodne_cislo").value.trim();
        let suggestionsBox = document.getElementById("suggestions");

        if (input.length < 3) {
            suggestionsBox.style.display = "none";
            return;
        }

        fetch(`/search_patient?query=${encodeURIComponent(input)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Chyba pri načítaní údajov.");
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error(data.error);
                    return;
                }

                suggestionsBox.innerHTML = "";
                if (data.length === 0) {
                    suggestionsBox.style.display = "none";
                    return;
                }

                data.forEach(patient => {
                    let div = document.createElement("div");
                    div.textContent = `${patient.rc} - ${patient.name} - ${patient.address}`;
                    div.classList.add("suggestion-item");

                    div.onclick = function () {
                        document.getElementById("rodne_cislo").value = patient.rc;
                        suggestionsBox.style.display = "none";
                        fillPatientDetails(patient);
                    };

                    suggestionsBox.appendChild(div);
                });

                suggestionsBox.style.display = "block";
            })
            .catch(error => {
                console.error("Chyba pri načítaní údajov:", error);
                alert("Chyba pri hľadaní pacienta. Skúste to znova.");
            });
    }

    function fillPatientDetails(patient) {
        document.getElementById("meno").value = patient.name;
        document.getElementById("adresa").value = patient.address;
        setSelectValue("poistovna", patient.insurance);
        setSelectValue("company", patient.company);
    }

    function setSelectValue(selectId, value) {
        let selectElement = document.getElementById(selectId);
        if (selectElement) {
            let optionExists = Array.from(selectElement.options).some(option => option.value === value);
            if (optionExists) {
                selectElement.value = value;
            }
        }
    }

    function setTodayDate() {
        let today = new Date().toISOString().split("T")[0];
        if (month && year) {
            document.getElementById("month").value = `${year}-${String(month).padStart(2, '0')}`;
        }
        if (start) {
            document.getElementById("zs_start_time").value = start;
        }
        if (end) {
            document.getElementById("zs_end_time").value = end;
        }
        if (write_start) {
            document.getElementById("write_start_time").value = write_start;
        }
        if (write_end) {
            document.getElementById("write_end_time").value = write_end;
        }
    }

    function setupDatePicker(datePickerId, selectedDatesContainerId, hiddenInputId) {
        let selectedDates = [];

        document.getElementById(datePickerId).addEventListener("change", function () {
            let rawDate = this.value;

            if (!rawDate || selectedDates.includes(rawDate)) return;

            selectedDates.push(rawDate);
            updateTokens();
        });

        function updateTokens() {
            let container = document.getElementById(selectedDatesContainerId);
            container.innerHTML = "";

            selectedDates.forEach(date => {
                date = formatDate(d);
                let token = document.createElement("div");
                token.classList.add("token");
                token.textContent = date;

                let removeBtn = document.createElement("button");
                removeBtn.textContent = "×";
                removeBtn.onclick = function () {
                    selectedDates = selectedDates.filter(d => d !== date);
                    updateTokens();
                };

                token.appendChild(removeBtn);
                container.appendChild(token);
            });

            document.getElementById(hiddenInputId).value = selectedDates.join(",");
        }

        function formatDate(dateString) {
            let date = new Date(dateString);
            if (isNaN(date)) return dateString; // Fallback if invalid date

            let day = String(date.getDate()).padStart(2, '0');
            let month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-based
            let year = date.getFullYear();

            return `${day}.${month}.${year}`;
        }
    }

    function clearInputs() {
        document.getElementById("meno").value = "";
        document.getElementById("rodne_cislo").value = "";
        document.getElementById("adresa").value = "";

        setSelectValue(poistovna, "24 - DÔVERA zdravotná poisťovňa, a. s.");
        setSelectValue(schedule, "každý deň");
        focusRodneCislo();
    }

    function fetchPlaceDetails(placeId) {
        const service = new google.maps.places.PlacesService(document.createElement("div"));

        service.getDetails(
            { placeId: placeId },
            function (place, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    console.log("Full Address:", place.formatted_address);
                    console.log("Latitude:", place.geometry.location.lat());
                    console.log("Longitude:", place.geometry.location.lng());
                }
            }
        );
    }

    //vyber adresy z moznosti
    document.addEventListener("click", function (event) {
        const suggestionsContainer = document.getElementById("address-suggestions");
        if (!event.target.closest("#adresa")) {
            suggestionsContainer.style.display = "none";
        }
    });

    //zmena dni vpravo vlavo
    document.addEventListener("DOMContentLoaded", function () {
        let selectedDateElement = document.getElementById("selectedDate");
        let prevButton = document.getElementById("prevDay");
        let nextButton = document.getElementById("nextDay");
        let patientList = document.getElementById("patientList");

        if (!Array.isArray(days) || days.length === 0) {
            selectedDateElement.textContent = "Žiadne dátumy";
            prevButton.disabled = true;
            nextButton.disabled = true;
            return;
        }

        let currentIndex = 0;
        selectedDateElement.textContent = days[currentIndex].datum;

        function updateDate() {
            let selectedDate = days[currentIndex].datum;
            selectedDateElement.textContent = selectedDate;
            prevButton.disabled = currentIndex === 0;
            nextButton.disabled = currentIndex === days.length - 1;

            // Fetch patients for the selected date
            updatePatientList(selectedDate);
        }

        prevButton.addEventListener("click", function () {
            if (currentIndex > 0) {
                currentIndex--;
                updateDate();
                updateRoute();

            }
        });

        nextButton.addEventListener("click", function () {
            if (currentIndex < days.length - 1) {
                currentIndex++;
                updateDate();
                updateRoute();

            }
        });

        function updatePatientList(selectedDate) {
            patientList.innerHTML = "";

            if (patients_by_day[selectedDate]) {
                patients_by_day[selectedDate].forEach(patient => {
                    let patientToken = document.createElement("div");
                    patientToken.classList.add("draggable", "token");
                    patientToken.setAttribute("draggable", "true");
                    patientToken.setAttribute("data-rc", patient.patient_rc);
                    patientToken.setAttribute("data-id", patient.patient_id);
                    patientToken.setAttribute("data-name", patient.patient_name);
                    patientToken.setAttribute("data-address", patient.patient_address);
                    patientToken.setAttribute("data-insurance", patient.insurance);
                    patientToken.setAttribute("data-company", patient.company);
                    patientToken.textContent = `${patient.patient_name}`;

                    // Add click event to populate inputs
                    patientToken.addEventListener("click", function () {
                        document.getElementById("rodne_cislo").value = this.getAttribute("data-rc");
                        document.getElementById("meno").value = this.getAttribute("data-name");
                        document.getElementById("adresa").value = this.getAttribute("data-address");
                        setSelectValue("poistovna", this.getAttribute("data-insurance"));
                        setSelectValue("company", this.getAttribute("data-company"));
                    });

                    // Create delete icon
                    let deleteIcon = document.createElement("span");
                    deleteIcon.innerHTML = "X";
                    deleteIcon.classList.add("delete-icon");

                    // Delete event listener
                    deleteIcon.addEventListener("click", function (event) {
                        event.stopPropagation();
                        showDeletePopup(patientToken, patient.patient_id, selectedDate);
                    });

                    // Append delete icon to the patient token
                    patientToken.appendChild(deleteIcon);
                    patientList.appendChild(patientToken);
                });
            }
        }

        function showDeletePopup(element, patientId, selectedDate) {
            let popup = document.getElementById("delete-popup");
            let overlay = document.getElementById("overlay");

            popup.style.display = "block";
            overlay.style.display = "block";

            window.selectedPatient = { element, patientId, selectedDate };
        }
    });

    function deletePatientDatabase() {
        let { element, patientId } = window.selectedPatient;

        fetch('/delete_patient', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: patientId })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(error => console.error("Error:", error));
    }

    function deletePatientDay() {
        let { patientId, selectedDate } = window.selectedPatient;

        fetch('/delete_patient_day', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ patient_id: patientId, date: selectedDate })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(error => console.error("Fetch error:", error));
    }

    function deletePatientMonth() {
            let { patientId, selectedDate } = window.selectedPatient;

            fetch('/delete_patient_month', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ patient_id: patientId, date: selectedDate })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert("Error: " + data.error);
                    }
                })
                .catch(error => console.error("Fetch error:", error));
        }

    function closeDeletePopup() {
        document.getElementById("delete-popup").style.display = "none";
        document.getElementById("overlay").style.display = "none";
    }

    // obmedzenie kalendaru iba na zvoleny mesiac
    function updateCalendar() {
        let firstDay = new Date(year, month - 1, 1);
        let lastDay = new Date(year, month, 0);

        flatpickr("#date_start", {
            dateFormat: "d-m-Y",
            enableTime: false,
            disableMobile: false,
            allowInput: true,
            minDate: firstDay,
            maxDate: lastDay,
            locale: {
                firstDayOfWeek: 1
            }
        });

        flatpickr("#date_end", {
            dateFormat: "d-m-Y",
            enableTime: false,
            disableMobile: false,
            allowInput: true,
            minDate: firstDay,
            maxDate: lastDay,
            locale: {
                firstDayOfWeek: 1
            }
        });
    }

    function fetchSuggestions() {
        const input = document.getElementById("adresa");
        const suggestionsContainer = document.getElementById("address-suggestions");
        const query = input.value.trim();

        if (!autocompleteService) {
            autocompleteService = new google.maps.places.AutocompleteService();
        }

        if (query.length < 3) {
            suggestionsContainer.style.display = "none";
            return;
        }

        autocompleteService.getPlacePredictions(
            {
                input: query,
                types: ["geocode"], 
                componentRestrictions: { country: "SK" } // Restrict to Slovakia (optional)
            },
            function (predictions, status) {
                if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions) {
                    suggestionsContainer.style.display = "none";
                    return;
                }

                // Clear old suggestions
                suggestionsContainer.innerHTML = "";

                predictions.forEach(prediction => {
                    const suggestionItem = document.createElement("div");
                    suggestionItem.textContent = prediction.description;

                    suggestionItem.addEventListener("click", function () {
                        input.value = prediction.description; // Set selected address
                        suggestionsContainer.style.display = "none"; // Hide dropdown
                        fetchPlaceDetails(prediction.place_id); // Get full place details
                    });

                    suggestionsContainer.appendChild(suggestionItem);
                });

                suggestionsContainer.style.display = "block";
            }
        );
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 48.3396, lng: 19.6677 },
            zoom: 10,
            disableDefaultUI: true,
            zoomControl: true,
            gestureHandling: "greedy"
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ map });

        updateRoute();
    }

    async function updateRoute() {
        let customRouteCheckbox = document.getElementById("custom-route");

        // Clear existing markers
        patientMarkers.forEach(marker => marker.setMap(null));
        patientMarkers = [];

        let listItems = document.querySelectorAll(".token");
        let waypoints = [];

        let startAddress = document.getElementById("start").value;
        let startCoords = await geocodeAddress(startAddress);

        if (!startCoords) {
            console.warn("Invalid start location.");
            return;
        }

        // Collect waypoints
        for (let item of listItems) {
            let address = item.dataset.address;
            let coords = await geocodeAddress(address);

            if (coords) {
                waypoints.push({ location: address });
            }
        }

        if (waypoints.length === 0) {
            return;
        }

        let routeChunks = splitWaypoints(waypoints, 20);
        let allLegs = [];

        let previousEnd = startAddress;
        for (let i = 0; i < routeChunks.length; i++) {
            let segmentWaypoints = routeChunks[i];

            let isLastSegment = (i === routeChunks.length - 1);
            let segmentDestination = isLastSegment ? startAddress : segmentWaypoints.pop().location;

            let request = {
                origin: previousEnd,
                destination: segmentDestination,
                waypoints: segmentWaypoints,
                optimizeWaypoints: customRouteCheckbox.checked,
                travelMode: google.maps.TravelMode.DRIVING
            };

            let result = await calculateRoute(request);
            if (result) {
                allLegs.push(...result.routes[0].legs); // Merge legs into one list
            }

            previousEnd = segmentDestination; // Set next segment start
        }

        // Display the full route information in one table
        displayRouteInfo(allLegs);
    }

    function splitWaypoints(waypoints, chunkSize) {
        let chunks = [];
        for (let i = 0; i < waypoints.length; i += chunkSize) {
            chunks.push(waypoints.slice(i, i + chunkSize));
        }
        return chunks;
    }

    // Function to calculate and return each route segment
    async function calculateRoute(request) {
        return new Promise((resolve) => {
            directionsService.route(request, function (result, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result); // Show last segment on map
                    resolve(result);
                } else {
                    console.error("Error fetching route:", status);
                    resolve(null);
                }
            });
        });
    }

    // Updated displayRouteInfo to handle multiple segments
    function displayRouteInfo(legs) {
        let table = document.getElementById("route-info");
        table.innerHTML = "";

        let startTimeInput = document.getElementById("zs_start_time").value;
        let writeStartTimeInput = document.getElementById("write_start_time").value;

        let startTime = new Date(`1970-01-01T${startTimeInput}:00`);
        let writeStartTime = new Date(`1970-01-01T${writeStartTimeInput}:00`);

        const waitTime = 20;
        const writeTimeIncrease = 5;

        let totalTime = 0;
        let totalDistance = 0;

        legs.forEach((leg, index) => {
            let duration = leg.duration ? Math.round(leg.duration.value / 60) : 0;
            let end = leg.end_address;

            let arrivalTime = new Date(startTime);
            arrivalTime.setMinutes(arrivalTime.getMinutes() + duration + waitTime);

            let patientWriteTime = new Date(writeStartTime);
            patientWriteTime.setMinutes(patientWriteTime.getMinutes() + writeTimeIncrease);

            let formattedArrivalTime = `${arrivalTime.getHours().toString().padStart(2, "0")}:${arrivalTime.getMinutes().toString().padStart(2, "0")}`;
            let formattedWriteTime = `${patientWriteTime.getHours().toString().padStart(2, "0")}:${patientWriteTime.getMinutes().toString().padStart(2, "0")}`;

            startTime.setMinutes(startTime.getMinutes() + duration + waitTime);
            writeStartTime.setMinutes(writeStartTime.getMinutes() + writeTimeIncrease);

            let row = `
    <tr>
        <td>${index + 1}.</td>
        <td>${end}</td>
        <td>${formattedArrivalTime}</td>
        <td>${formattedWriteTime}</td>
    </tr>`;
            table.innerHTML += row;
        });
    }

    async function geocodeAddress(address) {
        let geocoder = new google.maps.Geocoder();

        return new Promise((resolve) => {
            geocoder.geocode({ address: address }, (results, status) => {
                if (status === google.maps.GeocoderStatus.OK) {
                    resolve(results[0].geometry.location);
                } else {
                    console.error("Geocoding error:", status);
                    resolve(null);
                }
            });
        });
    }

    // vytvorit mapu pri nacitani stranky
    document.addEventListener("DOMContentLoaded", function () {
        initMap();
    });

    // horizontal scroll
    document.addEventListener("DOMContentLoaded", function () {
        const scrollContainer = document.querySelector(".scroll");

        scrollContainer.addEventListener("wheel", (evt) => {
            evt.preventDefault(); // Prevents default vertical scroll
            scrollContainer.scrollLeft += evt.deltaY * 2; // Adjust scroll speed
        });
    });

    function getDisallowedDaysForPatient(id_patient, patientsByDay, firstDay, lastDay) {
        let allDays = new Set();
        let allowedDays = new Set();

        // Generate all days in the month in YYYY-MM-DD format
        let currentDate = new Date(firstDay);
        while (currentDate <= lastDay) {
            let formattedDate = currentDate.toISOString().split("T")[0]; // Convert to "YYYY-MM-DD"
            allDays.add(formattedDate);
            currentDate.setDate(currentDate.getDate() + 1); // Move to next day
        }

        // Find allowed days for the patient
        if (typeof patientsByDay === "object" && patientsByDay !== null) {
            Object.entries(patientsByDay).forEach(([date, patientsOnDay]) => {
                if (Array.isArray(patientsOnDay)) {
                    let patientFound = patientsOnDay.some(patient => patient.patient_id == id_patient);
                    if (patientFound) {
                        allowedDays.add(date); // Store allowed dates
                    }
                }
            });
        }

        // Find disallowed days (days in the month that are NOT in allowedDays)
        let disallowedDays = [...allDays].filter(date => !allowedDays.has(date));

        return disallowedDays; // Return only the dates that are not allowed
    }

    function setFlatpickrDatepickers() {
        let firstDay = new Date(year, month - 1, 1);
        let lastDay = new Date(year, month, 0);

        document.getElementById("start_date_patient").value = firstDay.toLocaleDateString("sv-SE");
        document.getElementById("end_date_patient").value = lastDay.toLocaleDateString("sv-SE");

        let patientId = document.getElementById("patient_input_id").value;
        let disabledDays = getDisallowedDaysForPatient(patientId, patients_by_day, firstDay, lastDay);

        let datePickers = {};

        function applyFlatpickr(inputId) {
            let inputElem = document.getElementById(inputId);
            let index = inputId.split("_")[2];
            let hiddenInput = document.getElementById(`dates_list_${index}`);
            let copyPasteArea = document.getElementById(`copy_paste_dates_${index}`);

            datePickers[inputId] = flatpickr(inputElem, {
                mode: "multiple",
                dateFormat: "Y-m-d",
                minDate: firstDay,
                maxDate: lastDay,
                enableTime: false,
                allowInput: true,
                disable: disabledDays,
                locale: { firstDayOfWeek: 1 },
                onChange: function (selectedDates) {
                    updateDateFields(index, selectedDates);
                    inputElem.value = "";
                }
            });

            function updateDateFields(index, selectedDates) {
                let selectedValues = selectedDates.map(date => {
                    let adjustedDate = new Date(date);
                    adjustedDate.setDate(adjustedDate.getDate() + 1); // Add one day
                    return adjustedDate.toISOString().split("T")[0]; // Convert to YYYY-MM-DD
                });

                let hiddenInput = document.getElementById(`dates_list_${index}`);
                let copyPasteArea = document.getElementById(`copy_paste_dates_${index}`);

                hiddenInput.value = selectedValues.join(",");
                copyPasteArea.value = selectedValues.join(", ");
            }
        }

        for (let i = 1; i < 9; i++) {
            applyFlatpickr(`date_picker_${i}`);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        function updateHiddenInput(index) {
            let copyPasteArea = document.getElementById(`copy_paste_dates_${index}`);
            let hiddenInput = document.getElementById(`dates_list_${index}`);

            if (!copyPasteArea || !hiddenInput) {
                console.warn(`Missing elements for index ${index}`);
                return;
            }

            copyPasteArea.addEventListener("input", function () {
                let dates = copyPasteArea.value
                    .split(",") // Split by commas
                    .map(date => date.trim()) // Remove extra spaces
                    .filter(date => date); // Remove empty values

                hiddenInput.value = dates.join(","); // Update the hidden input
            });
        }

        // Apply to all `copy_paste_dates_X` textareas
        for (let i = 1; i <= 8; i++) {
            updateHiddenInput(i);
        }
    });
    
    async function schedulePatientsMonth() {
        const loader = document.getElementById("loader");
        loader.classList.add("loader-active");

        let customRouteCheckbox = document.getElementById("custom-route");
        let startAddress = document.getElementById("start").value;
        let startCoords = await geocodeAddress(startAddress);
        let sestra_id = document.getElementById("nurse_id").value;

        if (!startCoords) {
            console.warn("Invalid start location.");
            loader.classList.remove("loader-active");
            return;
        }

        let generatedSchedule = [];

        for (let day of days) {
            let selectedDate = day.datum;
            let waypoints = [];

            if (!patients_by_day[selectedDate] || patients_by_day[selectedDate].length === 0) {
                console.warn(`No patients scheduled for ${selectedDate}.`);
                continue;
            }

            let originalWaypoints = [];

            for (let patient of patients_by_day[selectedDate]) {
                let address = patient.patient_address;
                let coords = await geocodeAddress(address);

                if (coords) {
                    let waypoint = { location: address, patient_id: patient.patient_id };
                    waypoints.push({ location: address });
                    originalWaypoints.push(waypoint);
                }
            }

            if (waypoints.length === 0) {
                console.warn(`No valid addresses for ${selectedDate}.`);
                continue;
            }

            // 🔹 **Split into chunks of max 20 stops**
            let routeChunks = splitWaypoints(waypoints, 20);
            let previousEnd = startAddress;
            let fullRouteLegs = [];

            for (let i = 0; i < routeChunks.length; i++) {
                let segmentWaypoints = routeChunks[i];

                let isLastSegment = (i === routeChunks.length - 1);
                let segmentDestination = isLastSegment ? startAddress : segmentWaypoints.pop().location;

                let request = {
                    origin: previousEnd,
                    destination: segmentDestination,
                    waypoints: segmentWaypoints,
                    optimizeWaypoints: customRouteCheckbox.checked,
                    travelMode: google.maps.TravelMode.DRIVING
                };

                await new Promise((resolve) => {
                    directionsService.route(request, async function (result, status) {
                        if (status === google.maps.DirectionsStatus.OK) {
                            let optimizedWaypointsOrder = result.routes[0].waypoint_order;
                            let reorderedWaypoints = optimizedWaypointsOrder.map(index => originalWaypoints[index]);

                            fullRouteLegs.push(...result.routes[0].legs); // 🔹 Merge legs into one list

                            let scheduleData = await processRouteTimes(fullRouteLegs, selectedDate, reorderedWaypoints);
                            generatedSchedule.push(...scheduleData);
                        } else {
                            console.error(`Error fetching route for ${selectedDate}:`, status);
                        }
                        resolve();
                    });
                });

                previousEnd = segmentDestination;
            }
        }

        setTimeout(() => {
            sendScheduleToBackend(generatedSchedule, sestra_id);
            loader.classList.remove("loader-active");
        }, 3000);
    }

    async function processRouteTimes(legs, selectedDate, waypoints) {
        let startTimeInput = document.getElementById("zs_start_time").value;
        let writeStartTimeInput = document.getElementById("write_start_time").value;

        let startTime = new Date(`1970-01-01T${startTimeInput}:00`);
        let writeStartTime = new Date(`1970-01-01T${writeStartTimeInput}:00`);

        const waitTime = 20;
        const writeTimeIncrease = 5;

        let scheduleData = [];

        legs.forEach((leg, index) => {
            if (!waypoints[index]) {
                console.warn(`Missing waypoint for leg ${index}`);
                return;
            }

            let patientId = waypoints[index].patient_id;

            function getRandomTimeOffset() {
                return Math.floor(Math.random() * 31) - 30;
            }

            let arrivalTime = new Date(startTime);
            arrivalTime.setMinutes(arrivalTime.getMinutes() + Math.round(leg.duration.value / 60) + getRandomTimeOffset());

            let patientWriteTime = new Date(writeStartTime);
            patientWriteTime.setMinutes(patientWriteTime.getMinutes() + writeTimeIncrease + getRandomTimeOffset());

            let formattedArrivalTime = `${arrivalTime.getHours().toString().padStart(2, "0")}:${arrivalTime.getMinutes().toString().padStart(2, "0")}`;
            let formattedWriteTime = `${patientWriteTime.getHours().toString().padStart(2, "0")}:${patientWriteTime.getMinutes().toString().padStart(2, "0")}`;

            startTime.setMinutes(startTime.getMinutes() + Math.round(leg.duration.value / 60) + waitTime);
            writeStartTime.setMinutes(writeStartTime.getMinutes() + writeTimeIncrease);

            scheduleData.push({
                patient_id: patientId,
                date: selectedDate,
                arrival_time: formattedArrivalTime,
                write_time: formattedWriteTime
            });
        });

        return scheduleData;
    }

    function sendScheduleToBackend(scheduleData, sestra_id) {
        fetch("/update_schedule", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ schedule: scheduleData, sestra_id: sestra_id })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("dekurz-section").classList.remove("inactive");
                } else {
                    alert("Chyba pri vytváraní rozvrhu: " + data.error);
                }
            })
            .catch(error => {
                console.error("Chyba pri vytváraní rozvrhu:", error);
            });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const patientButtons = document.querySelectorAll(".small-token");
        const patientInfoDiv = document.querySelector(".patient-info");

        let parsedPatients = JSON.parse(patients_in_month);

        if (!Array.isArray(parsedPatients)) {
            console.error("Parsed data is not an array:", parsedPatients);
            return;
        }

        let patientData = {};
        parsedPatients.forEach(patient => {
            patientData[patient.id] = patient;
        });

        patientButtons.forEach(button => {
            button.addEventListener("click", function () {
                let patientId = this.getAttribute("data-id");

                if (patientId in patientData) {
                    let patient = patientData[patientId];


                    // Update the patient-info div with the clicked patient's details
                    patientInfoDiv.innerHTML = `
                        <p><strong>Meno:</strong> ${patient.meno}</p>
                        <p><strong>Rodné číslo:</strong> ${patient.rodne_cislo}</p>
                        <p><strong>Adresa:</strong> ${patient.adresa}</p>
                        <p><strong>Poisťovňa:</strong> ${patient.poistovna}</p>
                    `;

                    // Populate hidden input with patient ID
                    document.getElementById("patient_input_id").value = patientId;
                    document.getElementById("entry_number").value = patient.cislo_dekurzu || "";

                    for (let i = 1; i <= 8; i++) {
                        let podtextField = document.getElementById(`podtext-${i}`);
                        if (podtextField) {
                            podtextField.value = patient[`dekurz_text_${i - 1}`];
                        }
                    }

                    setFlatpickrDatepickers();

                    
                    for (let i = 1; i <= 8; i++) {
                        let datePicker = document.getElementById(`date_picker_${i}`);
                        let hiddenDateList = document.getElementById(`dates_list_${i}`);

                        if (datePicker && datePicker._flatpickr) {
                            datePicker._flatpickr.clear();
                        }

                        if (patient[`dekurz_dates_${i}`]) {
                            let dates = patient[`dekurz_dates_${i}`].split(",").map(date => date.trim()); // Convert string to array
                            if (datePicker && datePicker._flatpickr) {
                                datePicker._flatpickr.setDate(dates, true);
                            }
                            if (hiddenDateList) {
                                hiddenDateList.value = dates.join(", ");
                            }
                        }
                    }
                } else {
                    console.warn("Patient not found in preloaded data.");
                }
            });
        });
    });

    async function updateForDekurz() {
        let patientData = {
            patient_id: document.getElementById("patient_input_id").value,
            entry_number: document.getElementById("entry_number").value,
            nurse_id: document.getElementById("nurse_id").value,
            start: document.getElementById("start_date_patient").value,
            end: document.getElementById("end_date_patient").value
        };

        for (let i = 1; i < 9; i++) {
            patientData[`podtext_${i}`] = document.getElementById(`podtext-${i}`).value;
            patientData[`dates_list_${i}`] = document.getElementById(`dates_list_${i}`).value
                .split(",")
                .map(date => date.trim())
                .filter(date => date);
        }



        try {
            let response = await fetch("/update_patient", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(patientData)
            });

            let data = await response.json();

            if (data.success) {
                setTimeout(() => {
                    generateSchedule(patientData);
                }, 1000);
            } else {
                alert("Error updating patient: " + data.error);
            }
        } catch (error) {
            console.error("Error updating patient:", error);
        }
    }

    async function generateSchedule(patientData) {
        try {
            console.log("Sending data to generate schedule:", patientData);

            let response = await fetch("/generate_schedule", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(patientData)
            });

        } catch (error) {
            console.error("Error generating schedule:", error);
        }
    }

    function shutDown() {
        fetch("/shutdown", {
            method: "POST"
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("Server shutdown successful.");
                } else {
                    console.error("Error shutting down server:", data.error);
                }
            })
            .catch(error => {
                console.error("Error shutting down server:", error);
            });
    }

</script>