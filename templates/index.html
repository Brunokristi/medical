<!DOCTYPE html>
<html lang="sk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ADOS - Formulár pre správu údajov">
    <title>ADOS</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@200;300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRnAl8oUEx8je9s7J0zB7vPxIxAgyc_8c&libraries&libraries=places&callback=initMap" async defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
        }   

        .main {
            overflow: hidden;
            display: flex;
            max-height: calc(100vh - 40px);
        }

        h1, h2, h3 {
            margin: 10px;
            text-transform: uppercase;
            font-weight: 300;
        }

        h1 {
            font-size: 1.5em;
            color: #fff;
        }

        h2 {
            text-align: center;
            color: #ccc;
            font-size: medium;
        }

        h3 {
            text-align: center;
            color: #333;
            font-size: medium;
        }

        .top {
            background-color: #333;
            color: white;
            padding: 10px;
            max-height: 40px;
            display: flex;
            align-items: center;
            box-sizing: border-box;
        }

        .container {
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .left {
            background-color: #fff;
            width: 30%;
            border-right: #333 1px solid;
        }

        .right {
            background-color: #fff;
            width: 70%;
        }

        .section {
            padding: 30px;
            height: fit-content;
            border: solid 1px #ccc;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .lined-heading {
            display: flex;
            align-items: center;
            text-align: center;
            white-space: nowrap;
            margin: 30px 0;
        }

        .lined-heading::before,
        .lined-heading::after {
            content: "";
            flex-grow: 1;
            height: 1px;
            background-color: #ccc;
        }
    
        label {
            font-weight: 400;
            margin-bottom: 5px;
            color: #333;
        }
    
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            position: relative;
            justify-content: flex-end;
            width: 100%;
        }

        .half-form-group {
            display: flex;
            gap: 10px;            
        }

        .dates {
            width: 200px;
        }

        input, select, textarea {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 14px;
            font-family: Arial, Helvetica, sans-serif;
            width: 100%;
            box-sizing: border-box;
            color: #333;
        }
    
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: solid 1px #5C9EAD;
            border-radius: 20px;
            display: none;
            z-index: 10;
            max-height: 150px;
            overflow-y: auto;
        }
    
        .suggestions div {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #5C9EAD;
        }
    
        .suggestions div:hover {
            background: #f0f0f0;
        }

        .token button {
            background: none;
            border: none;
            color: white;
            font-weight: bold;
            margin-left: 5px;
            cursor: pointer;
        }

        .btn {
            background-color: #5C9EAD;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            width: 200px;
        }

        .btn.warning {
            background-color: #fff;
            color: #5C9EAD;
            border: 1px solid #5C9EAD;
        }

        .text-button {
            display: flex;
            justify-content: center;
            background: none;
            color: #5C9EAD;
            font-size: 24px;
            cursor: pointer;
            border: none;
            align-self: center;
            width: 100%;
        }

        .text-button i {
            width: 20px;
            height: 20px;
            color: #5C9EAD;
        }

        .hidden {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, opacity 0.5s ease-out;
        }

        .hidden.show {
            max-height: 500px;
            opacity: 1;
        }

        .one-line {
            gap: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .one-line button {
            background-color: #5C9EAD;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .one-line button i {
            font-size: 20px;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;

        }

        #draggable-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .token {
            padding: 8px;
            background: #5C9EAD;
            border-radius: 20px;
            cursor: grab;
            color: white;
            display: flex;
            width: 100%;
            box-sizing: border-box;
        }

        .button-container {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .dragging {
            opacity: 0.5;
        }

        .scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .small-token {
            padding: 8px;
            background: #5C9EAD;
            border-radius: 20px;
            cursor: pointer;
            color: white;
            display: flex;
            width: 100%;
            box-sizing: border-box;
            border: none;
            min-width: 100px;
            scroll-behavior: smooth;
        }

        ::-webkit-scrollbar {
            width: 3px;  /* Adjust width for vertical scrollbar */
            height: 3px; /* Adjust height for horizontal scrollbar */
        }

        /* Minimalist scrollbar track */
        ::-webkit-scrollbar-track {
            background: transparent; /* Make track invisible */
        }

        /* Minimalist scrollbar thumb (the moving part) */
        ::-webkit-scrollbar-thumb {
            background: #333; /* Light gray thumb */
        }

        /* Change thumb color on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #333;
        }


    </style>    
</head>
<body>
    <div class="top">
        <h1>ADOS</h1>
    </div>

    <div class="main">
        <div class="left container">
            <div class="section">
                <div class="form-group">
                    <label for="month">Mesiac</label>
                    <input type="month" id="month" name="month" required>
                </div>
                
                <div class="hidden">
                    <div class="half-form-group">
                        <div class="form-group">
                            <label for="zs_start_time">Čas poskytnutia ZS</label>
                            <input type="time" id="zs_start_time" name="zs_start_time" value="08:00" required>
                        </div>
                    
                        <div class="form-group">
                            <input type="time" id="zs_end_time" name="zs_end_time" value="14:00" required>
                        </div>
                    </div>
                    
                    <div class="half-form-group">
                        <div class="form-group">
                            <label for="write_start_time">Čas zápisu</label>
                            <input type="time" id="write_start_time" name="write_start_time" value="14:00" required>
                        </div>
                    
                        <div class="form-group">
                            <input type="time" id="write_end_time" name="write_end_time" value="15:30" required>
                        </div>
                    </div>
                </div>
                
                <button class="text-button"><i class="bi bi-chevron-compact-down"></i></button>


            </div>

            <div class="section">
                <h2 class="lined-heading"><span>Pacient</span></h2>
                <div class="form-group">
                    <label for="rodne_cislo">Rodné číslo</label>
                    <input type="text" id="rodne_cislo" name="rodne_cislo" maxlength="11" oninput="searchPatient()" autocomplete="off" required>
                    <div id="suggestions" class="suggestions"></div>
                </div>

                <div class="form-group">
                    <label for="meno">Meno</label>
                    <input type="text" id="meno" name="meno" required>
                </div>
                
                <div class="form-group">
                    <label for="adresa">Adresa</label>
                    <input type="text" id="adresa" name="adresa" required autocomplete="off" oninput="fetchSuggestions()">
                    <div id="address-suggestions" class="suggestions"></div>
                </div>
                
                <div class="form-group">
                    <label for="poistovna">Zdravotná poisťovňa</label>
                    <select id="poistovna" name="poistovna" required>
                        <option>24 – DÔVERA zdravotná poisťovňa, a. s.</option>
                        <option>25 – VŠEOBECNÁ zdravotná poisťovňa, a. s.</option>
                        <option>27 – UNION zdravotná poisťovňa, a. s.</option>
                    </select>
                </div>
                
                <h2 class="lined-heading"><span>Dátumy a časy</span></h2>
                
                
                <div class="half-form-group">
                    <div class="form-group">
                        <label for="date_start">Dátum poskytovania ZS</label>
                        <input type="date" id="date_start" name="date_start" required>
                    </div>
                
                    <div class="form-group">
                        <input type="date" id="date_end" name="date_end" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="schedule">Opakovanie</label>
                    <select id="schedule" name="schedule" required>
                        <option>Každý deň</option>
                        <option>Každý pracovný deň</option>
                        <option>3x v týždni</option>
                    </select>
                </div>

                <div class="one-line">
                    <button class="btn warning" onclick="clearInputs()">Vymazať</button>
                    <button class="btn" onclick="handleAddPatient(); clearInputs()">Pridať</button>
                </div>
            </div>

            <div class="section">
                <div class="one-line">
                    <button><i class="bi bi-arrow-left-short"></i></button>
                    <h3 class="selected-date"> 1.1.2025</h3>
                    <button><i class="bi bi-arrow-right-short"></i></button>
                </div>

                <div class="form-group">
                    <label for="start">Začiatok cesty</label>
                    <select id="start" name="start" required onchange="updateRoute()">
                        <option>Mieru 1969/1, Lučenec, BC, Slovensko</option>
                        <option>SNP 8, Fiľakovo, BC, Slovensko</option>
                    </select>
                </div>

                <div id="draggable-container"></div>
                
                <h2 class="lined-heading"><span>Informácia o ceste</span></h2>
                <table id="route-info" border="1" style="width: 100%; border-collapse: collapse; text-align: center;">
                </table>
                
                <div id="map" style="height: 400px; width: 100%; margin-top: 20px;"></div>
            </div>
        </div>

        <div class="right container">
            <div class="section">
                <div class="scroll">
                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>

                    <button class="small-token">
                        <span>John Doe</span>
                    </button>
                </div>
                
                <h2 class="lined-heading"><span>Pacient</span></h2>

                <div class="patient-info">
                    <p>Meno: Bruno Kristian</p>
                    <p>Rodné číslo: 12345678901</p>
                    <p>Adresa: Mieru 1969/1, Lučenec, BC, Slovensko</p>
                    <p>Poisťovňa: 24 – DÔVERA zdravotná poisťovňa, a. s.</p>
                </div>

                <h2 class="lined-heading"><span>Nález</span></h2>
                
                
                <div class="form-group">
                    <label for="hl-text">Nález</label>
                    <textarea id="hl-text" name="hl-text" rows="5" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="podtext-1" style="margin-top: 30px;">Základné ošetrenie</label>
                    <textarea id="podtext-1" name="podtext-1" rows="5"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="date_picker_1">Dátumy vykonania základného ošetrenia</label>
                    <input class="dates" type="text" id="date_picker_1" placeholder="Vyberte dátumy" readonly>
                    <div id="selected_dates_1" class="tokens-container"></div>
                    <input type="hidden" id="dates_list_1" name="dates_list_1">
                </div>

                
                <div class="form-group">
                    <label for="podtext-2" style="margin-top: 30px;">Doplnkové ošetrenie</label>
                    <textarea id="podtext-2" name="podtext-2" rows="5"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="date_picker_2">Dátumy vykonania doplnkového ošetrenia</label>
                    <input class="dates" type="date" id="date_picker_2">
                    <div id="selected_dates_2" class="tokens-container"></div>
                    <input type="hidden" id="dates_list_2" name="dates_list_2">
                </div>
                
                <div class="form-group">
                    <label for="koniec-mesiaca" style="margin-top: 30px;">Zhodnotenie na koniec mesiaca</label>
                    <textarea id="koniec-mesiaca" name="koniec-mesiaca" rows="5"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="date_picker_3">Dátum zhodnotenia na konieci mesiaca</label>
                    <input class="dates" type="date" id="date_picker_3">
                    <div id="selected_dates_3" class="tokens-container"></div>
                    <input type="hidden" id="dates_list_3" name="dates_list_3">
                </div>
                
                <div class="form-group">
                    <label for="entry_number" style="margin-top: 30px;">Číslo dekurzu</label>
                    <input type="number" id="entry_number" name="entry_number" oninput="validateNumberInput(this)" required>
                </div>

                <h2 class="lined-heading"><span>Pracovník a spoločnosť</span></h2>
                
                
                <div class="form-group">
                    <label for="name_worker">Meno vypĺňajúceho</label>
                    <input type="text" id="name_worker" name="name_worker" required>
                </div>
                
                <div class="form-group">
                    <label for="company">ADOS</label>
                    <select id="company" name="company" required>
                        <option>Andramed</option>
                        <option>ADANED</option>
                    </select>
                </div>
                
                <div style="display: flex; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="generateSchedule()">Vytvoriť Dekurz</button>
                </div>
            </div>
        </div>
    </div>

</body>

<script>
    let autocompleteService;
    let map;
    let routeLayer;
    let patientMarkers = [];
    let selectedDates = [];

    window.onload = function () {
        setTodayDate();
    };

    document.addEventListener("DOMContentLoaded", function () {
        const toggleButton = document.querySelector(".text-button");
        const hiddenSection = document.querySelector(".hidden");
        const icon = toggleButton.querySelector("i");

        toggleButton.addEventListener("click", function () {
            if (hiddenSection.classList.contains("show")) {
                hiddenSection.classList.remove("show");
                icon.classList.remove("bi-chevron-compact-up");
                icon.classList.add("bi-chevron-compact-down");
            } else {
                hiddenSection.classList.add("show");
                icon.classList.remove("bi-chevron-compact-down");
                icon.classList.add("bi-chevron-compact-up");
            }
        });

        focusRodneCislo();
    });

    function focusRodneCislo() {
        setTimeout(() => {
            let input = document.getElementById("rodne_cislo");
            if (input) {
                input.focus();
            }
        }, 500);
    }

    function searchPatient() {
            let input = document.getElementById("rodne_cislo").value.trim();
            let suggestionsBox = document.getElementById("suggestions");

            if (input.length < 3) {
                suggestionsBox.style.display = "none";
                return;
            }

            fetch(`http://127.0.0.1:5000/search_patient?query=${encodeURIComponent(input)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Chyba pri načítaní údajov.");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }

                    suggestionsBox.innerHTML = "";
                    if (data.length === 0) {
                        suggestionsBox.style.display = "none";
                        return;
                    }

                    data.forEach(patient => {
                        let div = document.createElement("div");
                        div.textContent = `${patient.rc} - ${patient.name} - ${patient.address}`;

                        div.onclick = function () {
                            document.getElementById("rodne_cislo").value = patient.rc;
                            suggestionsBox.style.display = "none";
                            fillPatientDetails(patient);
                        };
                        suggestionsBox.appendChild(div);
                    });

                    suggestionsBox.style.display = "block";
                })
                .catch(error => {
                    console.error("Chyba pri načítaní údajov:", error);
                });
        }

    function fillPatientDetails(patient) {
        document.getElementById("meno").value = patient.name;
        document.getElementById("adresa").value = patient.address;
        setSelectValue("poistovna", patient.insurance);
        setSelectValue("company", patient.company);
        document.getElementById("name_worker").value = patient.worker;

        // Populate additional fields
        document.getElementById("hl-text").value = patient.hl_text;
        document.getElementById("podtext-1").value = patient.podtext_1;
        document.getElementById("podtext-2").value = patient.podtext_2;
        document.getElementById("koniec-mesiaca").value = patient.koniec_mesiaca;
        document.getElementById("entry_number").value = patient.entry_number;
    }

    function setSelectValue(selectId, value) {
        let selectElement = document.getElementById(selectId);
        if (selectElement) {
            let optionExists = Array.from(selectElement.options).some(option => option.value === value);
            if (optionExists) {
                selectElement.value = value;
            }
        }
    }

    function setTodayDate() {
        let today = new Date().toISOString().split("T")[0];
        document.getElementById("date_start").value = today;
        document.getElementById("date_end").value = today;
        document.getElementById("month").value = today.substring(0, 7);
    }

    function setupDatePicker(datePickerId, selectedDatesContainerId, hiddenInputId) {
        let selectedDates = [];

        document.getElementById(datePickerId).addEventListener("change", function () {
            let rawDate = this.value;

            if (!rawDate || selectedDates.includes(rawDate)) return;

            selectedDates.push(rawDate);
            updateTokens();
        });

        function updateTokens() {
            let container = document.getElementById(selectedDatesContainerId);
            container.innerHTML = "";

            selectedDates.forEach(date => {
                date = formatDate(d);
                let token = document.createElement("div");
                token.classList.add("token");
                token.textContent = date;

                let removeBtn = document.createElement("button");
                removeBtn.textContent = "×";
                removeBtn.onclick = function () {
                    selectedDates = selectedDates.filter(d => d !== date);
                    updateTokens();
                };

                token.appendChild(removeBtn);
                container.appendChild(token);
            });

            document.getElementById(hiddenInputId).value = selectedDates.join(",");
        }

        function formatDate(dateString) {
            let date = new Date(dateString);
            if (isNaN(date)) return dateString; // Fallback if invalid date

            let day = String(date.getDate()).padStart(2, '0');
            let month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-based
            let year = date.getFullYear();

            return `${day}.${month}.${year}`;
        }
    }

    function handleAddPatient() {
        const patient = {
            rc: document.getElementById("rodne_cislo").value.trim(),
            name: document.getElementById("meno").value.trim(),
            address: document.getElementById("adresa").value.trim(),
            insurance: document.getElementById("poistovna").value.trim(),
            dateStart: document.getElementById("date_start").value,
            dateEnd: document.getElementById("date_end").value,
            schedule: document.getElementById("schedule").value,
        };

        // Validate required fields
        if (!patient.rc || !patient.name || !patient.address || !patient.dateStart || !patient.dateEnd) {
            alert("Vyplňte všetky povinné údaje pacienta.");
            return;
        }

        addPatientToList(patient);
    }

    function addPatientToList(patient) {
        let container = document.getElementById("draggable-container");

        let existingToken = [...container.children].find(div => div.dataset.rc === patient.rc);
        if (existingToken) return;

        let token = document.createElement("div");
        token.classList.add("token");
        token.dataset.rc = patient.rc;
        token.dataset.address = patient.address;
        token.draggable = true;

        // Patient details
        token.innerHTML = `<span>${patient.name} - ${patient.rc} - ${patient.address}</span>`;

        // Create button container
        let buttonContainer = document.createElement("div");
        buttonContainer.classList.add("button-container");

        // Remove button
        let removeBtn = document.createElement("button");
        removeBtn.classList.add("remove-btn");
        removeBtn.innerHTML = `<i class="bi bi-x"></i>`;
        removeBtn.onclick = function () {
            container.removeChild(token);
            updateRoute();
        };

        // let dragBtn = document.createElement("button");
        // dragBtn.classList.add("drag-btn");
        // dragBtn.innerHTML = `<i class="bi bi-grip-vertical"></i>`;

        buttonContainer.appendChild(removeBtn);
        // buttonContainer.appendChild(dragBtn);

        token.appendChild(buttonContainer);
        container.appendChild(token);

        // applyDragAndDrop();
        updateRoute();
    }

    function clearInputs() {
        let today = new Date().toISOString().split("T")[0];
        document.getElementById("meno").value = "";
        document.getElementById("rodne_cislo").value = "";
        document.getElementById("adresa").value = "";
        document.getElementById("date_start").value = today;
        document.getElementById("date_end").value = today;
        document.getElementById("period").value = "20";

        setSelectValue(poistovna, "24 - DÔVERA zdravotná poisťovňa, a. s.");
        setSelectValue(schedule, "každý deň");
        focusRodneCislo();
    }

    // function applyDragAndDrop() {
    //     let items = document.querySelectorAll(".token");

    //     items.forEach((item) => {
    //         item.draggable = true;
    //         item.removeEventListener("dragstart", dragStart);
    //         item.removeEventListener("dragend", dragEnd);
    //         item.addEventListener("dragstart", dragStart);
    //         item.addEventListener("dragend", dragEnd);
    //     });
    // }

    // function dragStart(e) {
    //     e.target.classList.add("dragging");
    // }

    // function dragEnd(e) {
    //     e.target.classList.remove("dragging");
    //     updateRoute();
    // }

    // document.getElementById("draggable-container").addEventListener("dragover", (e) => {
    //     e.preventDefault();
    //     const container = document.getElementById("draggable-container");
    //     const afterElement = getDragAfterElement(container, e.clientY);
    //     const draggedItem = document.querySelector(".dragging");
    //     if (draggedItem) {
    //         if (afterElement == null) {
    //             container.appendChild(draggedItem);
    //         } else {
    //             container.insertBefore(draggedItem, afterElement);
    //         }
    //     }
    // });

    // function getDragAfterElement(container, y) {
    //     const draggableElements = [...container.querySelectorAll(".token:not(.dragging)")];

    //     return draggableElements.reduce((closest, child) => {
    //         const box = child.getBoundingClientRect();
    //         const offset = y - box.top - box.height / 2;
    //         if (offset < 0 && offset > closest.offset) {
    //             return { offset: offset, element: child };
    //         } else {
    //             return closest;
    //         }
    //     }, { offset: Number.NEGATIVE_INFINITY }).element;
    // }

    // document.addEventListener("DOMContentLoaded", applyDragAndDrop);

    document.addEventListener("click", function (event) {
        const suggestionsContainer = document.getElementById("address-suggestions");
        if (!event.target.closest("#adresa")) {
            suggestionsContainer.style.display = "none";
        }
    });

    function fetchPlaceDetails(placeId) {
            const service = new google.maps.places.PlacesService(document.createElement("div"));

            service.getDetails(
                { placeId: placeId },
                function (place, status) {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        console.log("Full Address:", place.formatted_address);
                        console.log("Latitude:", place.geometry.location.lat());
                        console.log("Longitude:", place.geometry.location.lng());
                    }
                }
            );
        }

    
    



    function generateSchedule() {
        let data = {
            meno: document.getElementById("meno").value.trim(),
            rodne_cislo: document.getElementById("rodne_cislo").value.trim(),
            adresa: document.getElementById("adresa").value.trim(),
            poistovna: document.getElementById("poistovna").value.trim(),
            date_start: document.getElementById("date_start").value.trim(),
            date_end: document.getElementById("date_end").value.trim(),
            zs_start_time: document.getElementById("zs_start_time").value.trim(),
            zs_end_time: document.getElementById("zs_end_time").value.trim(),
            write_start_time: document.getElementById("write_start_time").value.trim(),
            write_end_time: document.getElementById("write_end_time").value.trim(),
            schedule: document.getElementById("schedule").value.trim(),
            name_worker: document.getElementById("name_worker").value.trim(),
            company: document.getElementById("company").value.trim(),
            hl_text: document.getElementById("hl-text").value.trim(),
            podtext_1: document.getElementById("podtext-1").value.trim(),
            dates_podtext_1: document.getElementById("dates_list_1").value.trim(),
            podtext_2: document.getElementById("podtext-2").value.trim(),
            dates_podtext_2: document.getElementById("dates_list_2").value.trim(),
            koniec_mesiaca: document.getElementById("koniec-mesiaca").value.trim(),
            dates_koniec_mesiaca: document.getElementById("dates_list_3").value.trim(),
            entry_number: document.getElementById("entry_number").value.trim()
        };

        fetch("http://127.0.0.1:5000/generate_schedule", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Chyba: " + data.error);
                } else {
                }
            })
            .catch(error => {
                console.error("Chyba pri generovaní rozvrhu:", error);
            });
    }

    setupDatePicker("date_picker_1", "selected_dates_1", "dates_list_1");
    setupDatePicker("date_picker_2", "selected_dates_2", "dates_list_2");
    setupDatePicker("date_picker_3", "selected_dates_3", "dates_list_3");


    function fetchSuggestions() {
        const input = document.getElementById("adresa");
        const suggestionsContainer = document.getElementById("address-suggestions");
        const query = input.value.trim();

        if (!autocompleteService) {
            autocompleteService = new google.maps.places.AutocompleteService();
        }

        if (query.length < 3) {
            suggestionsContainer.style.display = "none";
            return;
        }

        autocompleteService.getPlacePredictions(
            {
                input: query,
                types: ["geocode"], 
                componentRestrictions: { country: "SK" } // Restrict to Slovakia (optional)
            },
            function (predictions, status) {
                if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions) {
                    suggestionsContainer.style.display = "none";
                    return;
                }

                // Clear old suggestions
                suggestionsContainer.innerHTML = "";

                predictions.forEach(prediction => {
                    const suggestionItem = document.createElement("div");
                    suggestionItem.textContent = prediction.description;

                    suggestionItem.addEventListener("click", function () {
                        input.value = prediction.description; // Set selected address
                        suggestionsContainer.style.display = "none"; // Hide dropdown
                        fetchPlaceDetails(prediction.place_id); // Get full place details
                    });

                    suggestionsContainer.appendChild(suggestionItem);
                });

                suggestionsContainer.style.display = "block";
            }
        );
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 48.3396, lng: 19.6677 },
            zoom: 10,
            disableDefaultUI: true,
            zoomControl: true,
            gestureHandling: "greedy"
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ map });

        updateRoute();
    }

    async function updateRoute() {
        patientMarkers.forEach(marker => marker.setMap(null));
        patientMarkers = [];

        let listItems = document.querySelectorAll(".token");
        let waypoints = [];

        let startAddress = document.getElementById("start").value;
        let startCoords = await geocodeAddress(startAddress);

        if (!startCoords) {
            console.warn("Invalid start location.");
            return;
        }

        for (let item of listItems) {
            let address = item.dataset.address;
            let coords = await geocodeAddress(address);

            if (coords) {
                waypoints.push({ location: address });
            }
        }

        if (waypoints.length === 0) {
            console.warn("Not enough waypoints to generate a route.");
            return;
        }

        let request = {
            origin: startAddress,
            destination: startAddress,
            waypoints: waypoints,
            optimizeWaypoints: true,
            travelMode: google.maps.TravelMode.DRIVING
        };

        directionsService.route(request, function (result, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(result);
                displayRouteInfo(result);
            } else {
                console.error("Error fetching route:", status);
            }
        });
    }

    async function geocodeAddress(address) {
        let geocoder = new google.maps.Geocoder();

        return new Promise((resolve) => {
            geocoder.geocode({ address: address }, (results, status) => {
                if (status === google.maps.GeocoderStatus.OK) {
                    resolve(results[0].geometry.location);
                } else {
                    console.error("Geocoding error:", status);
                    resolve(null);
                }
            });
        });
    }

    function displayRouteInfo(result) {
        let table = document.getElementById("route-info");
        table.innerHTML = "";

        let totalDistance = 0;
        let totalTime = 0;
        const waitTime = 20; // ✅ Time spent at each location in minutes

        let headerRow = `
<tr>
    <th>#</th>
    <th>From</th>
    <th>To</th>
    <th>Distance (km)</th>
    <th>Travel Time (min)</th>
    <th>Wait Time (min)</th>
</tr>`;
        table.innerHTML += headerRow;

        let legs = result.routes[0].legs;

        for (let i = 0; i < legs.length; i++) {
            let leg = legs[i];

            let distance = leg.distance ? (leg.distance.value / 1000).toFixed(2) : "-";
            let duration = leg.duration ? (leg.duration.value / 60).toFixed(2) : "-";

            totalDistance += parseFloat(distance);
            totalTime += parseFloat(duration) + (i < legs.length - 1 ? waitTime : 0); // ✅ Add wait time except for the final return leg

            let row = `<tr>
        <td>${i + 1}</td>
        <td>${leg.start_address}</td>
        <td>${leg.end_address}</td>
        <td>${distance}</td>
        <td>${duration}</td>
        <td>${i < legs.length - 1 ? waitTime : "-"}</td> <!-- ✅ No wait time at final return -->
    </tr>`;
            table.innerHTML += row;
        }

        // ✅ Correct return leg (from last visited address back to the starting address)
        let lastVisitedAddress = legs[legs.length - 1].end_address;
        let startingAddress = legs[0].start_address;

        let returnDistance = legs[legs.length - 1].distance ? (legs[legs.length - 1].distance.value / 1000).toFixed(2) : "-";
        let returnDuration = legs[legs.length - 1].duration ? (legs[legs.length - 1].duration.value / 60).toFixed(2) : "-";

        totalDistance += parseFloat(returnDistance);
        totalTime += parseFloat(returnDuration); // ✅ No additional stop time at final return

        let returnRow = `<tr>
    <td>${legs.length + 1}</td>
    <td>${lastVisitedAddress}</td>
    <td>${startingAddress}</td>
    <td>${returnDistance}</td>
    <td>${returnDuration}</td>
    <td>-</td> <!-- ✅ No wait time at final return -->
</tr>`;
        table.innerHTML += returnRow;

        let totalRow = `<tr style="font-weight: bold;">
    <td colspan="3">Total</td>
    <td>${totalDistance.toFixed(2)} km</td>
    <td>${totalTime.toFixed(2)} min</td>
    <td>-</td>
</tr>`;
        table.innerHTML += totalRow;
    }

    function initAutocomplete() {
        let input = document.getElementById("adresa");

        const autocomplete = new google.maps.places.Autocomplete(input, {
            types: ["geocode"],
            componentRestrictions: { country: "SK" }
        });

        autocomplete.addListener("place_changed", function () {
            let place = autocomplete.getPlace();
            if (!place.geometry) {
                console.log("No details available for input:", input.value);
                return;
            }

            input.value = place.formatted_address;
        });
    }

    document.getElementById("start").addEventListener("change", updateRoute);

    document.addEventListener("DOMContentLoaded", function () {
        initMap();
        initAutocomplete();
    });

    document.addEventListener("DOMContentLoaded", function () {
        const scrollContainer = document.querySelector(".scroll");

        scrollContainer.addEventListener("wheel", (evt) => {
            evt.preventDefault(); // Prevents default vertical scroll
            scrollContainer.scrollLeft += evt.deltaY * 2; // Adjust scroll speed
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
            const dateInput = document.getElementById("date_picker_1");
            const selectedDatesContainer = document.getElementById("selected_dates_1");
            const hiddenInput = document.getElementById("dates_list_1");

            // Define disabled dates
            const disabledDates = ["2025-02-25", "2025-02-28"]; // Change these to real disabled dates

            // Flatpickr Configuration
            const calendar = flatpickr(dateInput, {
                mode: "multiple", // Allow multiple date selection
                dateFormat: "Y-m-d", // Display format
                minDate: "today", // Prevent selecting past dates
                disable: disabledDates, // Disable specific dates
                onChange: function (selectedDates) {
                    // Clear previous tokens
                    selectedDatesContainer.innerHTML = "";

                    // Create tokens for selected dates
                    selectedDates.forEach(date => {
                        let token = document.createElement("span");
                        token.classList.add("date-token");
                        token.textContent = date.toISOString().split("T")[0];

                        // Remove date on click
                        token.addEventListener("click", function () {
                            calendar.setDate(
                                calendar.selectedDates.filter(d => d.toISOString().split("T")[0] !== token.textContent),
                                true
                            );
                        });

                        selectedDatesContainer.appendChild(token);
                    });

                    // Update hidden input value with selected dates
                    hiddenInput.value = selectedDates.map(date => date.toISOString().split("T")[0]).join(",");
                }
            });

            // Custom styles to color selected days in the calendar
            document.head.insertAdjacentHTML("beforeend", `
        <style>
            .date-token {
                display: inline-block;
                background-color: #007bff;
                color: white;
                padding: 5px 10px;
                margin: 3px;
                border-radius: 5px;
                cursor: pointer;
            }
            .date-token:hover {
                background-color: #0056b3;
            }
            .flatpickr-day.selected {
                background: #007bff !important; /* Change selected day color */
                color: white !important;
            }
            .flatpickr-day.disabled {
                background: #ff6b6b !important; /* Change disabled day color */
                color: white !important;
                pointer-events: none;
            }
        </style>
    `);
        });


</script>